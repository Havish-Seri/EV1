<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <title>EV1 Console | PID Tuning</title>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        input[type=range] { appearance: none; background: #e2e8f0; border-radius: 99px; height: 4px; }
        input[type=range]::-webkit-slider-thumb {
            appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #0f172a; cursor: pointer; border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .tab-content { display: none; }
        .tab-content.active { display: flex; }
        .font-code { font-family: 'JetBrains Mono', 'Fira Code', monospace; }
        .peer:checked ~ .peer-checked-bg { background-color: #0f172a; }
        .peer:checked ~ .peer-checked-dot { transform: translateX(100%); }
    </style>
</head>
<body class="text-slate-900 overflow-hidden h-screen w-screen flex flex-col">

    <div class="h-12 bg-white border-b border-slate-200 flex items-center px-6 justify-between z-20">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-slate-900 rounded-sm"></div>
            <h1 class="text-sm font-extrabold uppercase tracking-tighter">EV1 Console <span class="text-slate-400 font-normal ml-2">v4.1</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="timerDisplay" class="font-code text-[10px] bg-slate-100 px-2 py-1 rounded border border-slate-200 text-slate-500">00.00s</div>
            <div id="statusBox" class="flex items-center gap-2 px-3 py-1 bg-amber-50 rounded border border-amber-200 text-[10px] font-bold text-amber-600">
                <div id="statusLed" class="w-1.5 h-1.5 bg-amber-400 rounded-full animate-pulse"></div> 
                <span id="statusText">WAITING FOR FLASK</span>
            </div>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <div class="flex-1 relative bg-white">
            <canvas id="field" class="absolute inset-0 w-full h-full"></canvas>
        </div>

        <div class="w-80 bg-slate-50 border-l border-slate-200 flex flex-col z-10 shadow-sm">
            <div class="flex border-b border-slate-200 bg-white">
                <button onclick="switchTab('drive')" id="tab-drive" class="flex-1 py-3 text-[10px] font-bold uppercase tracking-widest border-b-2 border-slate-900">Drive</button>
                <button onclick="switchTab('tune')" id="tab-tune" class="flex-1 py-3 text-[10px] font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent">Tuning</button>
            </div>

            <div id="content-drive" class="tab-content active flex-col p-5 gap-6 overflow-y-auto">
                <div class="space-y-4">
                    <div>
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Target Distance (ft)</label>
                        <input id="dist" type="number" value="3.0" step="0.1" class="w-full bg-white border border-slate-200 rounded p-2 text-xl font-bold mt-1 outline-none focus:border-slate-900">
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between text-[9px] font-black text-slate-400 uppercase tracking-widest">
                            <span>Steer Angle</span><span class="text-slate-900"><span id="angleVal">0</span>Â°</span>
                        </div>
                        <input id="turn" type="range" min="-45" max="45" value="0" class="w-full">
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between text-[9px] font-black text-slate-400 uppercase tracking-widest">
                            <span>Execute Time</span><span class="text-slate-900"><span id="durationVal">10</span>s</span>
                        </div>
                        <input id="duration" type="range" min="1" max="60" value="10" class="w-full">
                    </div>
                </div>

                <button onclick="startAnimation()" class="bg-slate-900 text-white w-full py-4 rounded font-bold uppercase tracking-widest text-[11px] hover:shadow-lg transition-all active:scale-95">Execute Path & Send</button>
            </div>

            <div id="content-tune" class="tab-content flex-col p-5 gap-4 overflow-y-auto">
                <div class="space-y-3">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Hardware Calibration</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="relative">
                            <input id="cfg-ticks" type="number" value="1000" class="w-full bg-white border border-slate-200 rounded p-2 text-[10px] font-code">
                            <span class="absolute right-2 top-2 text-[7px] text-slate-300">TICKS</span>
                        </div>
                        <div class="relative">
                            <input id="cfg-wheel" type="number" value="65" class="w-full bg-white border border-slate-200 rounded p-2 text-[10px] font-code">
                            <span class="absolute right-2 top-2 text-[7px] text-slate-300">DIA MM</span>
                        </div>
                    </div>
                </div>

                <div class="mt-2 border-t border-slate-200 pt-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-[9px] font-black text-slate-900 uppercase tracking-widest">PID Constants</h3>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="enable-pid" class="sr-only peer">
                            <div class="w-7 h-4 bg-slate-200 rounded-full peer-checked-bg transition-colors"></div>
                            <div class="absolute left-0.5 top-0.5 w-3 h-3 bg-white rounded-full transition-transform peer-checked-dot"></div>
                        </label>
                    </div>

                    <div id="pid-controls" class="space-y-3 opacity-30 pointer-events-none transition-opacity">
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="text-[7px] font-bold text-slate-400 uppercase">Kp</label>
                                <input id="pid-p" type="number" value="1.2" step="0.1" class="w-full bg-white border border-slate-200 rounded p-1 text-[10px] font-code">
                            </div>
                            <div>
                                <label class="text-[7px] font-bold text-slate-400 uppercase">Ki</label>
                                <input id="pid-i" type="number" value="0.01" step="0.001" class="w-full bg-white border border-slate-200 rounded p-1 text-[10px] font-code">
                            </div>
                            <div>
                                <label class="text-[7px] font-bold text-slate-400 uppercase">Kd</label>
                                <input id="pid-d" type="number" value="0.5" step="0.1" class="w-full bg-white border border-slate-200 rounded p-1 text-[10px] font-code">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-auto bg-white border-t border-slate-200 p-4">
                <div class="text-[8px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2 flex justify-between">
                    <span>Outgoing Serial Buffer</span>
                    <span id="bufferStatus" class="text-slate-300">IDLE</span>
                </div>
                <div id="jsonBuffer" class="bg-slate-50 border border-slate-200 rounded p-3 text-[9px] font-code text-slate-600 break-all h-16 overflow-y-auto">
                    {"status": "waiting"}
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('field'), ctx = canvas.getContext('2d');
        const distIn = document.getElementById('dist'), turnIn = document.getElementById('turn'), durIn = document.getElementById('duration');
        const pixelsPerFoot = 120;
        let startX, startY, isAnimating = false, startTime = 0;

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('content-' + tab).classList.add('active');
            document.getElementById('tab-drive').className = "flex-1 py-3 text-[10px] font-bold uppercase tracking-widest " + (tab === 'drive' ? "border-slate-900 text-slate-900" : "border-transparent text-slate-400");
            document.getElementById('tab-tune').className = "flex-1 py-3 text-[10px] font-bold uppercase tracking-widest " + (tab === 'tune' ? "border-slate-900 text-slate-900" : "border-transparent text-slate-400");
        }

        async function startAnimation() {
            startTime = performance.now(); 
            isAnimating = true; 
            
            const bufferContent = document.getElementById('jsonBuffer').innerText;
            
            // Send data to Flask Server
            try {
                const response = await fetch('http://localhost:5000/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: bufferContent
                });
                
                if (response.ok) {
                    document.getElementById('bufferStatus').innerText = "SENT TO PICO";
                    document.getElementById('bufferStatus').className = "text-emerald-500 font-bold";
                    document.getElementById('statusText').innerText = "LINKED";
                    document.getElementById('statusLed').className = "w-1.5 h-1.5 bg-emerald-400 rounded-full";
                } else {
                    throw new Error("Pico Offline");
                }
            } catch (e) {
                document.getElementById('bufferStatus').innerText = "SERVER ERROR";
                document.getElementById('bufferStatus').className = "text-red-500 font-bold";
                document.getElementById('statusText').innerText = "OFFLINE";
            }
            
            render(startTime);
        }

        function getPathPoint(t, distanceFeet, steeringAngleDeg) {
            const totalDistPx = distanceFeet * pixelsPerFoot * t;
            const theta = steeringAngleDeg * (Math.PI / 180);
            const wheelbasePx = 1 * pixelsPerFoot; 

            if (Math.abs(steeringAngleDeg) < 0.5) return { x: startX, y: startY - totalDistPx, heading: 0 };
            const R = wheelbasePx / Math.tan(theta); 
            const angleTraveled = totalDistPx / R;
            return { x: startX + R - R * Math.cos(angleTraveled), y: startY - R * Math.sin(angleTraveled), heading: angleTraveled };
        }

        function render(now) {
            const dist = parseFloat(distIn.value) || 0, angle = parseInt(turnIn.value) || 0, duration = parseInt(durIn.value) * 1000;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Grid
            ctx.setLineDash([]); ctx.lineWidth = 0.5; ctx.strokeStyle = '#e2e8f0';
            for(let x = startX % pixelsPerFoot; x < canvas.width; x += pixelsPerFoot) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); }
            for(let y = startY % pixelsPerFoot; y < canvas.height; y += pixelsPerFoot) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }
            
            let progress = 0;
            if (isAnimating) {
                const elapsed = now - startTime;
                progress = Math.min(elapsed / duration, 1);
                document.getElementById('timerDisplay').innerText = (elapsed / 1000).toFixed(2) + "s";
                if (progress >= 1) isAnimating = false;
            }

            // Path Line
            ctx.setLineDash([5, 5]); ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(startX, startY);
            for(let t=0; t<=1.01; t+=0.02) { const pt = getPathPoint(t, dist, angle); ctx.lineTo(pt.x, pt.y); }
            ctx.stroke();

            // Robot Icon
            const pos = getPathPoint(progress, dist, angle);
            ctx.save(); ctx.translate(pos.x, pos.y); ctx.rotate(pos.heading);
            ctx.fillStyle = '#0f172a'; ctx.beginPath(); ctx.moveTo(0, -20); ctx.lineTo(-12, 10); ctx.lineTo(12, 10); ctx.closePath(); ctx.fill(); ctx.restore();
            
            if (isAnimating) requestAnimationFrame(render);
        }

        function updateEverything() {
            const pidEnabled = document.getElementById('enable-pid').checked;
            document.getElementById('pid-controls').className = pidEnabled ? "space-y-3 opacity-100 transition-opacity" : "space-y-3 opacity-30 pointer-events-none transition-opacity";

            document.getElementById('angleVal').innerText = turnIn.value;
            document.getElementById('durationVal').innerText = durIn.value;

            const data = {
                dist_ft: parseFloat(distIn.value),
                angle_deg: parseInt(turnIn.value),
                time_s: parseInt(durIn.value),
                pid: pidEnabled ? {
                    p: parseFloat(document.getElementById('pid-p').value),
                    i: parseFloat(document.getElementById('pid-i').value),
                    d: parseFloat(document.getElementById('pid-d').value)
                } : null
            };
            document.getElementById('jsonBuffer').innerText = JSON.stringify(data);
            render(performance.now());
        }

        function init() {
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            startX = canvas.width / 2; startY = canvas.height - 100;
            updateEverything();
        }

        document.querySelectorAll('input').forEach(i => i.oninput = updateEverything);
        window.addEventListener('resize', init);
        init();
    </script>
</body>
</html>
